name: YEONDEUNG CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      es_changed: ${{ steps.filter.outputs.elasticsearch }}
    steps:
      - uses: actions/checkout@v3

      # 1. 특정 폴더 변경 감지 (Elasticsearch 관련 파일만 체크)
      - name: Check for changes in elasticsearch
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            elasticsearch:
              - 'elasticsearch/**'

      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 2. Backend 이미지 빌드 및 푸시 (커밋 해시 태그 사용)
      - name: Build and Push Backend
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-be:${{ github.sha }} ./backend
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-be:${{ github.sha }}
          # 롤백 및 편의를 위해 latest 태그도 함께 업데이트
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-be:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-be:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-be:latest

      # 3. Elasticsearch 이미지 빌드 (폴더 내 변경 사항이 있을 때만 실행)
      - name: Build and Push Elasticsearch
        if: steps.filter.outputs.elasticsearch == 'true'
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-es:${{ github.sha }} ./elasticsearch
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-es:${{ github.sha }}
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-es:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-es:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/yeondeung-es:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/ubuntu/yeondeung-be
            
            # 1. .env 파일 관리 (기존 DB 설정 등 보존하면서 태그만 교체)
            touch .env
            
            # 기존 BE_TAG/ES_TAG 라인 삭제 후 현재 커밋 해시 주입
            sed -i '/^BE_TAG=/d' .env
            echo "BE_TAG=${{ github.sha }}" >> .env
            
            sed -i '/^ES_TAG=/d' .env
            if [ "${{ needs.build-and-push.outputs.es_changed }}" == "true" ]; then
              echo "ES_TAG=${{ github.sha }}" >> .env
            else
              # 이번에 ES 빌드가 없었다면 latest를 기본으로 사용하도록 설정
              if ! grep -q "ES_TAG=" .env; then echo "ES_TAG=latest" >> .env; fi
            fi
            
            # 2. 배포 실행
            sudo docker-compose pull app elasticsearch
            sudo docker-compose up -d --force-recreate --remove-orphans

            # 3. 컨테이너 내부 명령어 자동 실행
            echo "Waiting for app to start..."
            sleep 60 # 앱이 구동되고 DB/ES와 연결될 시간을 줌 (사양에 따라 조절)

            
            # 4. 미사용 오래된 이미지 정리
            sudo docker image prune -f