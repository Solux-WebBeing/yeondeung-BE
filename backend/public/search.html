<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연등 - 실시간 추천 검색어 테스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .suggestion-list {
            position: absolute;
            width: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 50;
        }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .suggestion-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="login-view" class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">검색 테스트 로그인</h2>
        <form id="login-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">아이디</label>
                <input type="text" id="userid" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
            </div>
            <button type="submit" id="login-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">로그인</button>
        </form>
        <p id="login-error" class="hidden mt-4 text-red-500 text-sm text-center"></p>
    </div>

    <div id="search-view" class="hidden w-full max-w-2xl bg-white p-8 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">실시간 추천 검색어</h2>
            <button id="logout-btn" class="text-sm text-red-500 hover:underline">로그아웃</button>
        </div>

        <div class="relative">
            <label class="block text-sm font-medium text-gray-500 mb-2">단어를 입력해보세요 (예: 기후, 활동)</label>
            <input type="text" id="search-input" 
                   class="w-full px-5 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition" 
                   placeholder="검색어 입력..." autocomplete="off">
            
            <div id="suggestion-box" class="suggestion-list"></div>
        </div>

        <div class="mt-8 p-4 bg-blue-50 rounded-lg">
            <p class="text-sm text-blue-700 font-mono">연결 상태: <span class="font-bold">인증됨 (토큰 자동 적용 중)</span></p>
        </div>
    </div>

    <script>
        // --- 설정 ---
        const API_BASE_URL = 'http://localhost:8000/api'; // 검색 서버 포트에 맞춰 수정하세요
        let adminToken = '';

        const loginView = document.getElementById('login-view');
        const searchView = document.getElementById('search-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const searchInput = document.getElementById('search-input');
        const suggestionBox = document.getElementById('suggestion-box');
        const logoutBtn = document.getElementById('logout-btn');

        // --- 1. 로그인 로직 (제공해주신 모듈 기반) ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userid = document.getElementById('userid').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userid, password })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || '로그인 실패');

                // 토큰 저장 및 뷰 전환
                adminToken = result.data.token;
                loginView.classList.add('hidden');
                searchView.classList.remove('hidden');
            } catch (err) {
                loginError.textContent = err.message;
                loginError.classList.remove('hidden');
            }
        });

        // --- 2. 추천 검색어 로직 (디바운스 적용) ---
        let debounceTimer;
        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const q = searchInput.value.trim();

            if (q.length < 1) {
                suggestionBox.style.display = 'none';
                return;
            }

            // 300ms 대기 후 호출
            debounceTimer = setTimeout(() => fetchSuggestions(q), 300);
        });

        async function fetchSuggestions(q) {
            try {
                const response = await fetch(`${API_BASE_URL}/search/suggest?q=${encodeURIComponent(q)}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}` // 저장된 토큰 사용
                    }
                });
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    renderSuggestions(result.data);
                } else {
                    suggestionBox.style.display = 'none';
                }
            } catch (err) {
                console.error('추천어 로드 실패:', err);
            }
        }

        function renderSuggestions(data) {
            suggestionBox.innerHTML = '';
            data.forEach(text => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = text;
                div.onclick = () => {
                    searchInput.value = text;
                    suggestionBox.style.display = 'none';
                    // 여기서 실제 검색 API를 호출하거나 페이지 이동 가능
                    console.log(`검색 실행: ${text}`);
                };
                suggestionBox.appendChild(div);
            });
            suggestionBox.style.display = 'block';
        }

        // 로그아웃
        logoutBtn.onclick = () => {
            adminToken = '';
            searchView.classList.add('hidden');
            loginView.classList.remove('hidden');
            searchInput.value = '';
        };

        // 외부 클릭 시 닫기
        document.addEventListener('click', (e) => {
            if (e.target !== searchInput) suggestionBox.style.display = 'none';
        });
    </script>
</body>
</html>